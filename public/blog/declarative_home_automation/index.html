<!DOCTYPE html>
<html lang="en">
<head>
	<title>Peter Hajas / Declarative Home Automation </title>
	<link rel="canonical" href="http://peterhajas.com">
	<link rel='alternate' type='application/rss+xml' title="Peter Hajas RSS" href='/rss.xml'>
	<link rel='stylesheet' type='text/css' href='/reset.css'>
	<link rel='stylesheet' type='text/css' href='/style.css'>

    <link rel="icon" type="image/png" href="/favicon_16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="/favicon_32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/favicon_96x96.png" sizes="96x96">

	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta charset="utf-8">
</head>
<body>
<header>
    <a href="/">
        <h1 class='sitetitle'>Peter Hajas</h1>
    </a>
    <nav>
        <a href="/about">About</a>
        •
        <a href="/internet_independence">Internet Independence</a>
        <br>
        <a href="/peterometer">Peterometer</a>
        •
        <a href="/pokemon_mapgen">Pokémon mapgen</a>
        •
        <a href="/forge">forge</a>
        •
        <a href="/draw">draw</a>
    </nav>
</header>

<main>
<h1 id="tag_Declarative Home Automation"><h2>Declarative Home Automation</h2>
<h3>

<time datetime="2022-05-21T20:30:00-07:00">2022-05-21</time>

</h3></h1>
<article>

<p>My home is powered by <a href="https://www.home-assistant.io">Home Assistant</a>, which is a great software package for running a smart home. In this post, I&rsquo;ll talk about how I&rsquo;m automating my home <em>declaratively</em> rather than using an &ldquo;if-this-then-that&rdquo; approach.</p>
<h1 id="lighting-the-patio">Lighting The Patio</h1>
<p>We have lights on our patio. I want them on if:</p>
<ul>
<li>it&rsquo;s after sunset and before 9:00PM
<em>or</em></li>
<li>the patio door was opened within the last 3 minutes at night (if I&rsquo;m going outside, or letting the dogs out)</li>
</ul>
<h2 id="the-classic-model-if-this-then-that">The Classic Model: &ldquo;If-This-Then-That&rdquo;</h2>
<p>If you did an &ldquo;if-this-then-that&rdquo; approach, you might have rules like:</p>
<ul>
<li>if it&rsquo;s after sunset but before 9:00PM, turn the lights on</li>
<li>if the back door opens while the sun is below the horizon, turn the lights on for 3 minutes</li>
</ul>
<p>While these rules sound simple, they have edge cases that will bite you when the cases fight each other. Imagine I&rsquo;m letting the dogs out at 8:59PM. Following the above rules:</p>
<ol>
<li>Door opens at 8:59PM, and the lights turn on</li>
<li>9:00PM comes, and the lights turn off</li>
<li>I&rsquo;m out in the dark!</li>
</ol>
<p>You could solve this by introducing more state. You might add a &ldquo;lights on due to time&rdquo; and &ldquo;lights on due to door opening&rdquo; state to bookkeep when to perform actions of the automation. But what if we add another rule? For example: if the back camera detects a person or dog, turn the lights on for three minutes.</p>
<p>Adding additional &ldquo;what am I doing&rdquo; state makes the complexity explode for state bookkeeping.</p>
<h2 id="a-declarative-model-should-state">A Declarative Model: &ldquo;Should&rdquo; State</h2>
<p>In my smart home, I take all this input state and derive a &ldquo;should be&rdquo; state out of it. The patio light automation has just one rule:</p>
<ul>
<li>If the patio lights <em>should</em> be on, then turn them on. Otherwise turn them off.</li>
</ul>
<p>I define these &ldquo;should be&rdquo; states with simple boolean logic in a <a href="https://www.home-assistant.io/integrations/template/">template binary sensor</a>. Here&rsquo;s the one for my patio lights:</p>
<pre><code>template:
  - binary_sensor:
    - name: &quot;Patio Lights Should Be On&quot;
      delay_off:
        minutes: 3
      state: &gt;
        {% set before9 = now().hour &lt; 21  %}
        {% set doorOpen = states('binary_sensor.patio_door') == 'on' %}
        {% set night = is_state('binary_sensor.night', 'on') %}
        {% set people = is_state('binary_sensor.patio_person_motion', 'on') %}
        {% set dog = is_state('binary_sensor.patio_dog_motion', 'on') %}
        {{ night and (before9 or doorOpen or people or dog) }}
</code></pre>
<p>I have a simple <a href="https://www.home-assistant.io/docs/automation/using_blueprints/">blueprint</a>, <code>binary_sensor_entity</code>, that manages these automations for me:</p>
<pre><code>blueprint:
  name: Binary Sensor to Entity
  description: Tie a binary sensor (likely from a template) to an entity state
  domain: automation
  input:
    source_sensor:
      name: Source Sensor
      description: This sensor will be used to drive the entity
      selector:
        entity:
          domain: binary_sensor
    target_entity:
      name: Target Entity
      description: The entity to be driven by the sensor
      selector:
        entity:

variables:
  source_sensor: !input source_sensor

trigger:
  - platform: state
    entity_id: !input source_sensor

action:
  - service: &gt;
      {% if is_state(source_sensor, &quot;on&quot;) %}
        homeassistant.turn_on
      {% else %}
        homeassistant.turn_off
      {% endif %}
    entity_id: !input target_entity
</code></pre>
<p>This makes the patio lights automation very simple:</p>
<pre><code>automation:
- alias: Lights - Patio - Primary
  use_blueprint:
    path: binary_sensor_entity.yaml
    input:
      source_sensor: binary_sensor.patio_lights_should_be_on
      target_entity: switch.patio_shelly_channel_1
</code></pre>
<p>My entire home is driven this way. I think this is easier to understand and extend than the classic way of doing Home Assistant automations. I also prefer it over <a href="https://nodered.org">Node-RED</a>, although I still use Node-RED for some tasks in my home (this may be a subject of a future post).</p>
<p>I like how well this addresses the edge case described above, and how easy it is to experiment with new states driving the &ldquo;should be&rdquo; sensors. I tried keeping the lights on during severe weather (I have since removed this), and it only took one change to the &ldquo;should be&rdquo; sensor for the patio lights. These sensors are also really easy to debug - you can view them in the History section of Home Assistant.</p>
<p>Please feel free to <a href="/about">drop me a line</a> if you have any feedback on this post. Thanks for reading!</p>


</article>
</main>
<hr>

<footer>
    <nav>
        <a href="/cool_sites">Cool Sites</a>
        •
        <a href="/site_info">Site Info</a>
        •
        <a href="/rss.xml">RSS</a>
        <br>
        <a href="/timer.html">Rummikub Timer</a>
    </nav>
    <a href="/">
        <img class="peterAvatar circle" src="/peter.jpg" alt="Peter smiling against a blue background">
    </a>
</footer>


</body>
</html>
